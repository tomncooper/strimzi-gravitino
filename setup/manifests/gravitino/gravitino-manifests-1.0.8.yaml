---
# Source: gravitino/charts/mysql/templates/networkpolicy.yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: gravitino-mysql
  namespace: "metadata"
  labels:
    app.kubernetes.io/instance: gravitino
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mysql
    app.kubernetes.io/version: 8.0.36
    helm.sh/chart: mysql-10.2.1
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/instance: gravitino
      app.kubernetes.io/managed-by: Helm
      app.kubernetes.io/name: mysql
      app.kubernetes.io/version: 8.0.36
      helm.sh/chart: mysql-10.2.1
  policyTypes:
    - Ingress
    - Egress
  egress:
    - {}
  ingress:
    - ports:
        - port: 3306
        - port: 3306
---
# Source: gravitino/charts/mysql/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gravitino-mysql
  namespace: "metadata"
  labels:
    app.kubernetes.io/instance: gravitino
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mysql
    app.kubernetes.io/version: 8.0.36
    helm.sh/chart: mysql-10.2.1
automountServiceAccountToken: false
secrets:
  - name: gravitino-mysql
---
# Source: gravitino/charts/mysql/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: gravitino-mysql
  namespace: "metadata"
  labels:
    app.kubernetes.io/instance: gravitino
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mysql
    app.kubernetes.io/version: 8.0.36
    helm.sh/chart: mysql-10.2.1
type: Opaque
data:
  mysql-root-password: "YWRtaW4="
  mysql-password: "Z3Jhdml0aW5v"
---
# Source: gravitino/charts/mysql/templates/primary/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: gravitino-mysql
  namespace: "metadata"
  labels:
    app.kubernetes.io/instance: gravitino
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mysql
    app.kubernetes.io/version: 8.0.36
    helm.sh/chart: mysql-10.2.1
    app.kubernetes.io/component: primary
data:
  my.cnf: |-
    [mysqld]
    default_authentication_plugin=mysql_native_password
    skip-name-resolve
    explicit_defaults_for_timestamp
    basedir=/opt/bitnami/mysql
    plugin_dir=/opt/bitnami/mysql/lib/plugin
    port=3306
    mysqlx=0
    mysqlx_port=33060
    socket=/opt/bitnami/mysql/tmp/mysql.sock
    datadir=/bitnami/mysql/data
    tmpdir=/opt/bitnami/mysql/tmp
    max_allowed_packet=16M
    bind-address=*
    pid-file=/opt/bitnami/mysql/tmp/mysqld.pid
    log-error=/opt/bitnami/mysql/logs/mysqld.log
    character-set-server=UTF8
    slow_query_log=0
    long_query_time=10.0
    
    [client]
    port=3306
    socket=/opt/bitnami/mysql/tmp/mysql.sock
    default-character-set=UTF8
    plugin_dir=/opt/bitnami/mysql/lib/plugin
    
    [manager]
    port=3306
    socket=/opt/bitnami/mysql/tmp/mysql.sock
    pid-file=/opt/bitnami/mysql/tmp/mysqld.pid
---
# Source: gravitino/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: gravitino
  namespace: metadata
  labels:
    app: gravitino
    chart: gravitino-1.0.8
    release: gravitino
data:
  init.sh: |-
    #!/bin/bash
    #
    # Licensed to the Apache Software Foundation (ASF) under one
    # or more contributor license agreements.  See the NOTICE file
    # distributed with this work for additional information
    # regarding copyright ownership.  The ASF licenses this file
    # to you under the Apache License, Version 2.0 (the
    # "License"); you may not use this file except in compliance
    # with the License.  You may obtain a copy of the License at
    #
    #  http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing,
    # software distributed under the License is distributed on an
    # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    # KIND, either express or implied.  See the License for the
    # specific language governing permissions and limitations
    # under the License.
    #
    
    
    cp /tmp/conf/* ${GRAVITINO_HOME}/conf
    cp /tmp/conf/log4j2.properties ${GRAVITINO_HOME}/conf
    
    echo "Start the Gravitino Server"
    /bin/bash ${GRAVITINO_HOME}/bin/gravitino.sh run
    
  gravitino.conf: |
    #
    # Licensed to the Apache Software Foundation (ASF) under one
    # or more contributor license agreements.  See the NOTICE file
    # distributed with this work for additional information
    # regarding copyright ownership.  The ASF licenses this file
    # to you under the Apache License, Version 2.0 (the
    # "License"); you may not use this file except in compliance
    # with the License.  You may obtain a copy of the License at
    #
    #  http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing,
    # software distributed under the License is distributed on an
    # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    # KIND, either express or implied.  See the License for the
    # specific language governing permissions and limitations
    # under the License.
    #
    
    # THE CONFIGURATION FOR Gravitino SERVER
    gravitino.server.shutdown.timeout = 3000
    
    # THE CONFIGURATION FOR Gravitino WEB SERVER
    gravitino.server.webserver.host = 0.0.0.0
    gravitino.server.webserver.httpPort = 8090
    gravitino.server.webserver.minThreads = 24
    gravitino.server.webserver.maxThreads = 200
    gravitino.server.webserver.stopTimeout = 30000
    gravitino.server.webserver.idleTimeout = 30000
    gravitino.server.webserver.threadPoolWorkQueueSize = 100
    gravitino.server.webserver.requestHeaderSize = 131072
    gravitino.server.webserver.responseHeaderSize = 131072
    
    # Comma-separated list of filter class names to apply to the API.
    gravitino.server.webserver.customFilters = 
    
    # Comma-separated list of REST API packages to expand
    gravitino.server.rest.extensionPackages = 
    
    # THE CONFIGURATION FOR Gravitino ENTITY STORE
    gravitino.entity.store = relational
    gravitino.entity.store.maxTransactionSkewTimeMs = 2000
    gravitino.entity.store.deleteAfterTimeMs = 604800000
    gravitino.entity.store.versionRetentionCount = 1
    gravitino.entity.store.relational = JDBCBackend
    gravitino.entity.store.relational.jdbcUrl = jdbc:mysql://gravitino-mysql:3306/gravitino
    gravitino.entity.store.relational.jdbcDriver = com.mysql.cj.jdbc.Driver
    gravitino.entity.store.relational.jdbcUser = gravitino
    gravitino.entity.store.relational.jdbcPassword = gravitino
    gravitino.entity.store.relational.storagePath = /root/gravitino/data/jdbc
    
    # THE CONFIGURATION FOR Gravitino CATALOG
    gravitino.catalog.cache.evictionIntervalMs = 3600000
    
    # THE CONFIGURATION FOR Gravitino Entity Cache
    gravitino.cache.enabled = true
    gravitino.cache.maxEntries = 10000
    gravitino.cache.expireTimeInMs = 3600000
    gravitino.cache.enableStats = false
    gravitino.cache.enableWeigher = true
    gravitino.cache.implementation = caffeine
    
    # THE CONFIGURATION FOR authorization
    gravitino.authorization.enable = false
    gravitino.authorization.serviceAdmins = anonymous
    gravitino.authenticators = simple
    gravitino.authenticator.oauth.serviceAudience = test
    gravitino.authenticator.oauth.defaultSignKey = 
    gravitino.authenticator.oauth.serverUri = 
    gravitino.authenticator.oauth.tokenPath = /realms/myrealm/protocol/openid-connect/token
    
    gravitino.authenticator.oauth.provider = 
    gravitino.authenticator.oauth.clientId = 
    gravitino.authenticator.oauth.authority = 
    gravitino.authenticator.oauth.scope = 
    gravitino.authenticator.oauth.jwksUri = 
    gravitino.authenticator.oauth.tokenValidatorClass = 
    gravitino.authenticator.oauth.principalFields = 
    
    # THE CONFIGURATION FOR AUXILIARY SERVICE
    gravitino.auxService.names = iceberg-rest
    gravitino.iceberg-rest.classpath = iceberg-rest-server/libs, iceberg-rest-server/conf
    gravitino.iceberg-rest.host = 0.0.0.0
    gravitino.iceberg-rest.httpPort = 9001
    gravitino.iceberg-rest.catalog-backend = memory
    gravitino.iceberg-rest.warehouse = /tmp/
    
    # Audit log configuration
    gravitino.audit.enabled = false
    gravitino.audit.writer.className = org.apache.gravitino.audit.FileAuditWriter
    gravitino.audit.formatter.className = org.apache.gravitino.audit.SimpleFormatter
    gravitino.audit.writer.file.fileName = gravitino_audit.log
    gravitino.audit.writer.file.flushIntervalSecs = 10
    gravitino.audit.writer.file.append = true
    
    # Metrics configuration
    gravitino.metrics.timeSlidingWindowSecs	= 60
  log4j2.properties: |-
    #
    # Licensed to the Apache Software Foundation (ASF) under one
    # or more contributor license agreements.  See the NOTICE file
    # distributed with this work for additional information
    # regarding copyright ownership.  The ASF licenses this file
    # to you under the Apache License, Version 2.0 (the
    # "License"); you may not use this file except in compliance
    # with the License.  You may obtain a copy of the License at
    #
    #  http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing,
    # software distributed under the License is distributed on an
    # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    # KIND, either express or implied.  See the License for the
    # specific language governing permissions and limitations
    # under the License.
    #
    
    status = warn
    
    # Log files location
    property.basePath = ${sys:gravitino.log.path}
    property.serverName = ${sys:gravitino.server.name}
    
    # RollingFileAppender name, pattern, path and rollover policy
    appender.rolling.type = RollingFile
    appender.rolling.name = fileLogger
    appender.rolling.fileName = ${basePath}/${serverName}.log
    appender.rolling.filePattern = ${basePath}/${serverName}_%d{yyyyMMdd}.log.gz
    appender.rolling.layout.type = PatternLayout
    appender.rolling.layout.pattern = %d{yyyy-MM-dd HH:mm:ss.SSS} %level [%t] [%l] - %msg%n
    appender.rolling.policies.type = Policies
    
    # RollingFileAppender rotation policy
    appender.rolling.policies.size.type = SizeBasedTriggeringPolicy
    appender.rolling.policies.size.size = 10MB
    appender.rolling.policies.time.type = TimeBasedTriggeringPolicy
    appender.rolling.policies.time.interval = 1
    appender.rolling.policies.time.modulate = true
    appender.rolling.strategy.type = DefaultRolloverStrategy
    appender.rolling.strategy.delete.type = Delete
    appender.rolling.strategy.delete.basePath = ${basePath}
    appender.rolling.strategy.delete.maxDepth = 10
    appender.rolling.strategy.delete.ifLastModified.type = IfLastModified
    
    # Delete all files older than 30 days
    appender.rolling.strategy.delete.ifLastModified.age = 30d
    
    # Configure root logger
    rootLogger.level = info
    rootLogger.appenderRef.rolling.ref = fileLogger
    appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss} %-5p [%t] %c{1}:%L - %m%n
    appender.console.layout.type = PatternLayout
    appender.console.name = consoleLogger
    appender.console.type = Console
    rootLogger.appenderRef.console.ref = consoleLogger
---
# Source: gravitino/charts/mysql/templates/primary/svc-headless.yaml
apiVersion: v1
kind: Service
metadata:
  name: gravitino-mysql-headless
  namespace: "metadata"
  labels:
    app.kubernetes.io/instance: gravitino
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mysql
    app.kubernetes.io/version: 8.0.36
    helm.sh/chart: mysql-10.2.1
    app.kubernetes.io/component: primary
spec:
  type: ClusterIP
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
    - name: mysql
      port: 3306
      targetPort: mysql
  selector:
    app.kubernetes.io/instance: gravitino
    app.kubernetes.io/name: mysql
    app.kubernetes.io/component: primary
---
# Source: gravitino/charts/mysql/templates/primary/svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: gravitino-mysql
  namespace: "metadata"
  labels:
    app.kubernetes.io/instance: gravitino
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mysql
    app.kubernetes.io/version: 8.0.36
    helm.sh/chart: mysql-10.2.1
    app.kubernetes.io/component: primary
spec:
  type: ClusterIP
  sessionAffinity: None
  ports:
    - name: mysql
      port: 3306
      protocol: TCP
      targetPort: mysql
      nodePort: null
  selector:
    app.kubernetes.io/instance: gravitino
    app.kubernetes.io/name: mysql
    app.kubernetes.io/component: primary
---
# Source: gravitino/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: gravitino
  namespace: metadata
  labels:
    app: gravitino
    chart: gravitino-1.0.8
    release: gravitino
  annotations:
    {}
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8090
      protocol: TCP
      targetPort: 8090
    - name: http1
      port: 9001
      protocol: TCP
      targetPort: 9001
  selector:
    app: gravitino
    release: gravitino
---
# Source: gravitino/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gravitino
  namespace: metadata
  labels:
    app: gravitino
    chart: gravitino-1.0.8
    release: gravitino
  annotations:
    {}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gravitino
      release: gravitino
  template:
    metadata:
      labels:
        app: gravitino
        name: gravitino
        release: gravitino
      annotations:
    spec:    
      initContainers:
      - name: sqlfile
        image: docker.io/apache/gravitino:1.0.0
        imagePullPolicy: "IfNotPresent"
        command:
        - /bin/bash
        - -c
        - |
          cp -r /root/gravitino/scripts/*  /tmp/scripts/
          VERSION=$(ls /root/gravitino/libs/gravitino-server-* | grep -oP '[0-9]+\.[0-9]+\.[0-9]+'|head -1)
          echo $VERSION > /tmp/scripts/version.txt
        resources:
          {}
        volumeMounts:
          - mountPath: /tmp/scripts/
            name: scripts-emptydir
      - name: init-mysql
        image: docker.io/bitnamilegacy/mysql:8.0.36-debian-12-r12
        imagePullPolicy: "IfNotPresent"
        command:
          - /bin/bash
          - -c
          - |
            while ! mysql -h gravitino-mysql -u root -e "SELECT 1"; do
              echo "Waiting for MySQL to be ready..."
              sleep 2
            done
            VERSION=$(cat /scripts/version.txt)
            if [ -z "$VERSION" ]; then
              echo "ERROR:Please set VERSION"
              exit 1
            fi
            dir="/scripts/mysql"
            schema_file=$(ls $dir/schema-*-mysql.sql | sort -V | awk -F'[-]' '$2 <= '$VERSION' {print $0}' | tail -n 1)
            if [ ! -f "$schema_file" ]; then
              echo "ERROR:Failed to find schema file $schema_file"
              exit 1
            fi
            upgrade_file=$(ls $dir/upgrade-*-to-*-mysql.sql | sort -V | awk -F'[-]' '$4 <= '$VERSION' {print $0}' | tail -n 1)
            if [ ! -f "$upgrade_file" ]; then
              echo "ERROR:Failed to find upgrade file $upgrade_file"
              exit 1
            fi
            echo "Schema file: $schema_file"
            echo "Upgrade file: $upgrade_file"
            if ! mysql -h gravitino-mysql -u root -D gravitino <"$upgrade_file"; then
              echo "WARNING: Upgrade script failed: $upgrade_file" >&2
              echo "Continuing with schema script..." >&2
            fi
            mysql -h gravitino-mysql -u root -D gravitino <$schema_file 
        resources:
          {}
        env:
          - name: MYSQL_PWD
            valueFrom:
              secretKeyRef:
                name: gravitino-mysql
                key: mysql-root-password
        volumeMounts:
          - mountPath: /scripts
            name: scripts-emptydir
      containers:
        - name: gravitino
          image: docker.io/apache/gravitino:1.0.0
          imagePullPolicy: "IfNotPresent"
          command:
            - "/bin/bash"
            - "/tmp/conf/init.sh"
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 20
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 20
            timeoutSeconds: 5
          resources:
            {}
          securityContext:
            runAsNonRoot: false
            runAsUser: 0
          env:
            - name: GRAVITINO_HOME
              value: /root/gravitino
            - name: GRAVITINO_MEM
              value: -Xms1024m -Xmx1024m -XX:MaxMetaspaceSize=512m            
          ports:
            - name: http
              containerPort: 8090
              protocol: TCP
            - name: http1
              containerPort: 9001
              protocol: TCP              
          volumeMounts:
            - name: gravitino-conf
              mountPath: /tmp/conf
            - name: storage
              mountPath: /root/gravitino/data/jdbc
            - mountPath: /root/gravitino/logs
              name: gravitino-log  
      nodeSelector:
        {}
      affinity:
        {}
      tolerations:
        []
      volumes:
        - name: gravitino-conf
          configMap:
            name: gravitino
        - emptyDir: {}
          name: scripts-emptydir
        - name: storage
          emptyDir: {}
        - emptyDir: {}
          name: gravitino-log
---
# Source: gravitino/charts/mysql/templates/primary/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: gravitino-mysql
  namespace: "metadata"
  labels:
    app.kubernetes.io/instance: gravitino
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mysql
    app.kubernetes.io/version: 8.0.36
    helm.sh/chart: mysql-10.2.1
    app.kubernetes.io/component: primary
spec:
  replicas: 1
  podManagementPolicy: ""
  selector:
    matchLabels:
      app.kubernetes.io/instance: gravitino
      app.kubernetes.io/name: mysql
      app.kubernetes.io/component: primary
  serviceName: gravitino-mysql
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      annotations:
        checksum/configuration: 01a87a51399922915a12f778d1eab987216f1332fc2bbe6e8e4574cbe8412cf1
      labels:
        app.kubernetes.io/instance: gravitino
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: mysql
        app.kubernetes.io/version: 8.0.36
        helm.sh/chart: mysql-10.2.1
        app.kubernetes.io/component: primary
    spec:
      serviceAccountName: gravitino-mysql
      
      automountServiceAccountToken: false
      affinity:
        podAffinity:
          
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/instance: gravitino
                    app.kubernetes.io/name: mysql
                topologyKey: kubernetes.io/hostname
              weight: 1
        nodeAffinity:
          
      securityContext:
        fsGroup: 1001
        fsGroupChangePolicy: Always
        supplementalGroups: []
        sysctls: []
      initContainers:
        - name: preserve-logs-symlinks
          image: docker.io/bitnamilegacy/mysql:8.0.36-debian-12-r12
          imagePullPolicy: "IfNotPresent"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: true
            runAsGroup: 1001
            runAsNonRoot: true
            runAsUser: 1001
            seLinuxOptions: {}
            seccompProfile:
              type: RuntimeDefault
          resources:
            limits:
              cpu: 750m
              ephemeral-storage: 1024Mi
              memory: 768Mi
            requests:
              cpu: 500m
              ephemeral-storage: 50Mi
              memory: 512Mi
          command:
            - /bin/bash
          args:
            - -ec
            - |
              #!/bin/bash

              . /opt/bitnami/scripts/libfs.sh
              # We copy the logs folder because it has symlinks to stdout and stderr
              if ! is_dir_empty /opt/bitnami/mysql/logs; then
                cp -r /opt/bitnami/mysql/logs /emptydir/app-logs-dir
              fi
          volumeMounts:
            - name: empty-dir
              mountPath: /emptydir
      containers:
        - name: mysql
          image: docker.io/bitnamilegacy/mysql:8.0.36-debian-12-r12
          imagePullPolicy: "IfNotPresent"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: true
            runAsGroup: 1001
            runAsNonRoot: true
            runAsUser: 1001
            seLinuxOptions: {}
            seccompProfile:
              type: RuntimeDefault
          env:
            - name: BITNAMI_DEBUG
              value: "false"
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: gravitino-mysql
                  key: mysql-root-password
            - name: MYSQL_USER
              value: "gravitino"
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: gravitino-mysql
                  key: mysql-password
            - name: MYSQL_PORT
              value: "3306"
            - name: MYSQL_DATABASE
              value: "gravitino"
          envFrom:
          ports:
            - name: mysql
              containerPort: 3306
          livenessProbe:
            failureThreshold: 3
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
            exec:
              command:
                - /bin/bash
                - -ec
                - |
                  password_aux="${MYSQL_ROOT_PASSWORD:-}"
                  if [[ -f "${MYSQL_ROOT_PASSWORD_FILE:-}" ]]; then
                      password_aux=$(cat "$MYSQL_ROOT_PASSWORD_FILE")
                  fi
                  mysqladmin status -uroot -p"${password_aux}"
          readinessProbe:
            failureThreshold: 3
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
            exec:
              command:
                - /bin/bash
                - -ec
                - |
                  password_aux="${MYSQL_ROOT_PASSWORD:-}"
                  if [[ -f "${MYSQL_ROOT_PASSWORD_FILE:-}" ]]; then
                      password_aux=$(cat "$MYSQL_ROOT_PASSWORD_FILE")
                  fi
                  mysqladmin status -uroot -p"${password_aux}"
          startupProbe:
            failureThreshold: 10
            initialDelaySeconds: 15
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
            exec:
              command:
                - /bin/bash
                - -ec
                - |
                  password_aux="${MYSQL_ROOT_PASSWORD:-}"
                  if [[ -f "${MYSQL_ROOT_PASSWORD_FILE:-}" ]]; then
                      password_aux=$(cat "$MYSQL_ROOT_PASSWORD_FILE")
                  fi
                  mysqladmin status -uroot -p"${password_aux}"
          resources:
            limits:
              cpu: 750m
              ephemeral-storage: 1024Mi
              memory: 768Mi
            requests:
              cpu: 500m
              ephemeral-storage: 50Mi
              memory: 512Mi
          volumeMounts:
            - name: data
              mountPath: /bitnami/mysql
            - name: empty-dir
              mountPath: /tmp
              subPath: tmp-dir
            - name: empty-dir
              mountPath: /opt/bitnami/mysql/conf
              subPath: app-conf-dir
            - name: empty-dir
              mountPath: /opt/bitnami/mysql/tmp
              subPath: app-tmp-dir
            - name: empty-dir
              mountPath: /opt/bitnami/mysql/logs
              subPath: app-logs-dir
            - name: config
              mountPath: /opt/bitnami/mysql/conf/my.cnf
              subPath: my.cnf
      volumes:
        - name: config
          configMap:
            name: gravitino-mysql
        - name: empty-dir
          emptyDir: {}
  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          app.kubernetes.io/instance: gravitino
          app.kubernetes.io/name: mysql
          app.kubernetes.io/component: primary
      spec:
        accessModes:
          - "ReadWriteOnce"
        resources:
          requests:
            storage: "8Gi"
---
# Source: gravitino/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: gravitino-test-connection
  namespace: metadata
  annotations:
    helm.sh/hook: test
    helm.sh/hook-delete-policy: hook-succeeded
spec:
  containers:
    - name: test-connection
      image: curlimages/curl:latest
      command:
        - /bin/sh
        - -c
        - |
          max_attempts=10
          attempt=0
          success=false

          while [ $attempt -lt $max_attempts ]; do
            response=$(curl -X GET -H "Content-Type: application/json" http://${SERVICE_NAME}:${SERVICE_PORT}/api/version)

            if echo "$response" | grep -q "\"code\":0"; then
              success=true
              break
            else
              echo "Attempt $((attempt + 1)) failed..."
              sleep 1
            fi

            ((attempt++))
          done

          if [ "$success" = true ]; then
            exit 0
          else
            exit 1
          fi
      env:
        - name: SERVICE_NAME
          value: "gravitino"
        - name: SERVICE_PORT
          value: "8090"
  restartPolicy: Never
